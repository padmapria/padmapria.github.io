<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Image-based vehicle traffic monitoring</title>
 
<meta name="author" content="Costas Courcoubetis, Francisco Benita and Geovani Benita" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />

<link rel="next" href="model.html"/>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />
<!--Font awesome Icons-->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
<link rel="stylesheet" href="style.css" type="text/css" />

<!-- try to highlight automatically the python code-->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/default.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</head>

<body>

  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Image-based vehicle traffic monitoring</a></li>

<!--Left bar-->
<ul class="summary"></ul>
<li class="divider"></li>
<li class="chapter" data-level="1.1" data-path="api.html"><a href="index.html">
  <i class="fa fa-check"></i> Summary </a></li>
  <li class="divider"></li>
<li class="chapter" data-level="1.1" data-path="api.html"><a href="api.html">
  <i class="fa fa-check"></i><b>1</b> API Connection</a></li>
<ul>
  <li class="chapter" data-level="1.1" data-path="api.html"><a href="#1.1">
    <i class="fa fa-check"></i><b>1.1</b> About this dataset</a>
  </li>
  <li class="chapter" data-level="1.2" data-path="api.html"><a href="#1.2">
    <i class="fa fa-check"></i><b>1.2</b> API example value</a></li>
  <li class="chapter" data-level="1.3" data-path="api.html"><a href="#1.3">
    <i class="fa fa-check"></i><b>1.3</b> Making an API request</a></li>
    <li class="chapter" data-level="1.4" data-path="api.html"><a href="#1.4">
      <i class="fa fa-check"></i><b>1.4</b> Upload files to dropbox</a></li>
    </ul>
    <li class="divider"></li>
<li class="chapter" data-level="2" data-path="model.html"><a href="model.html">
  <i class="fa fa-check"></i><b>2</b> Mask-RCNN Model</a></li>
<li class="divider"></li>
<li class="chapter" data-level="3" data-path="visualization.html"><a href="visualization.html">
  <i class="fa fa-check"></i><b>3</b> Visualization</a></li>
<li class="divider"></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="api.html">Image-based vehicle traffic monitoring</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">  

            <section class="normal" id="section-">
  <div id="my-awesome-project" class="section level1">
  <h1><span class="header-section-number">Chapter 1</span> API connection</h1>
  
    <h4>
      <div id="1.1">
        <span class="header-section-number">1.1</span>
        About this dataset
      </h4>
      </div> 
    <p align="justify">
    Get the latest images from traffic cameras all around <a href="https://data.gov.sg/dataset/traffic-images">Singapore.</a>
It returns links to images of live traffic conditions along expressways and Woodlands & Tuas Checkpoints. 
<ul>

  <li> Retrieved every 20 seconds from LTA's Datamall</li>
  <li> Locations of the cameras are also provided in the response </li>
  <li> We recommend calling this endpoint every 3 minutes</li>
</ul>  
  </p>
  <article>
    <table class="table">
        <tr>
          <th scope="row">Managed By</th>
          <td><a href="https://data.gov.sg/dataset?organization=land-transport-authority">Land Transport Authority</a></td>
        </tr>
  
          <tr>
            <th scope="row">Last Updated</th>
            <td>February 13, 2018, 14:49 (SGT)</td>
          </tr>
        
          <tr>
            <th scope="row">Created</th>
            <td>April 8, 2016, 15:55 (SGT)</td>
          </tr>
        
          <tr>
            <th scope="row">Coverage</th>
            
              <td>From March 1, 2016</td>
            
          </tr>
        
          <tr>
            <th scope="row">Frequency</th>
            <td>Real-time</td>
          </tr>
        
            <tr>
              <th scope="row">Source(s)</th>
              <td>Land Transport Authority</td>
            </tr>
          
        <tr>
          <th scope="row">Licence</th>
          <td><a href="https://data.gov.sg/open-data-licence">Singapore Open Data Licence</a></td>
        </tr>
    </table>
  </article>
<p>The request URL to the API is the following: </p>
<pre><code class="bash">https://api.data.gov.sg/v1/transport/traffic-images
</code></pre>
<p>You can simply copy and paste the link  in your preferred browser to see te JSON:API.</p>
<p>Curl</p>
<pre><code>$ curl -X GET "https://api.data.gov.sg/v1/transport/traffic-images" -H "accept: application/json"</code></pre>
<div id="1.2">
<h4>
  <span class="header-section-number">1.2<span></span>
  API example value</h4> 
</div>
<pre><code>{
  "api_info": {
    "status": "healthy"
  },
  "items": [
    {
      "timestamp": "2021-02-01T20:34:23.451Z",
      "cameras": [
        {
          "timestamp": "2021-02-01T20:34:23.451Z",
          "camera_id": 0,
          "image": "string",
          "image_metadata": {
            "height": 0,
            "width": 0,
            "md5": "string"
          }
        }
      ]
    }
  ]
}
</code></pre>
  <p>The retrieving parameters are: </p>
  <pre><code class= "js"> timestamp, camera_id, image </code></pre>
    <p>Note, the <code>timestamp</code> format: <blockquote> YYYY-MM-DD[T]HH:mm:ss (SGT)  </blockquote></p>
    <div id="1.3">
  <h4><span class="header-section-number">1.3</span>
    Making an API request</h4>
    </div>
    <p align="justify">First, we have to import the correspondent libraries to work with GET requests,
dataframes, datetime objects, etc.
    </p>
  <pre><code class="py">import requests
import datetime
import dropbox
import os 
import pandas as pd</code></pre>
<p align="justify">It its worthy to mention that we must have installed these libraries in our system. <code>pip3 install
   'library'</code> might be useful.
</p>
<p>Now we can make a request to the url as follows:</p>
<pre><code>endpoint = "https://api.data.gov.sg/v1/transport/traffic-images"

#response from API URL
data = requests.get(endpoint).json()      

#Prints all the json data
print(data.get('items'))</code></pre>

  <p align="justify">Once we have explored the API, we have to extract the desired parameters from json. At this point we have
     to select a <code>camera_id</code> to get the url's of the images. We recommend to choose a camera which has more traffic 
     flow. (i.e <code>1701</code>) to get the url's of the images. In addition, we must define initial and final timestamp variables. 
     This allow us to retrieve captured images within a time window (feel free to try different parameter values).
 Also, a <code>delta</code> variable referring to the time-window (in minutes) between each photo.</p>
  
<p align="justify">To this end, we can create a function <code>getURLS(date_format):</code> which will depend a list that store 
  our delta-timestamp strings</p>

    <pre><code class="python">def getURLS(date_format):
global times
#set a specific camera_id
req_camera_id = "1701"
#auxiliary variables
image=[] 
time =[]

  for i in range(len(date_format)):
      #Adjust timestamps to correct url format
      url_date = date_format[i].replace('/','-') 
      endpoint = "https://api.data.gov.sg/v1/transport/traffic-images?date_time="+url_date
      data = requests.get(endpoint)
      if (data):
          #if response status 200
          data = requests.get(endpoint).json()    
          for item in data['items']:
              for cam in item['cameras']:
                  camera_id = cam['camera_id']
                  if camera_id == req_camera_id:	
                      image = cam['image']
                      wanted_cam.append(camera_id)
                      wanted_url.append(image)
                      time.append(cam['timestamp'])
                      print(times[i])
df = pd.DataFrame(list(zip(wanted_cam, wanted_url,times)), 
                columns =['Cam_id', 'Image','Timestamp_sg_time'])
df.set_index('Cam_id', inplace=True) 
df.to_csv('/your/path/Wed-1-20-20.csv', sep=',', encoding='utf-8')

if __name__ == "__main__":    
  string_date_list = []   
  #Generate timestamps every N minutes. Parameters can be modified  
  #parameter order as follows : datetime(year. month, day, hours, min)
  initial_time = datetime.datetime(2020, 1, 20, 0, 0)
  final_time = datetime.datetime(2020, 1, 21, 0, 0)
  delta = datetime.timedelta(minutes=60) 
  times = []
  wanted_url=[]
  wanted_cam=[]
 
  while initial_time < final_time:
      times.append(initial_time)
      initial_time += delta
    
  for i in range(len(times)): #Convert datetime objects to string list    
      string_date_list.append((times[i].strftime('%Y/%m/%dT%H:%M:%S')))
  getURLS(string_date_list)
  </code></pre>  
<p>Let's review what exactly the code does:</p>
<p align="justify">The following for loop iterates over the length of the list <code>string_date_list</code>
which basically stores each <code>timestamp</code> according to <code>delta</code> variable. This is, every
 timestamp corresponds to one json file, thus the loop iterates over the keys and objects of each json  </p>
<pre><code>for i in range(len(date_format)):
#Adjust timestamps to correct url format
url_date = date_format[i].replace('/','-') 
endpoint = "https://api.data.gov.sg/v1/transport/traffic-images?date_time="+url_date
data = requests.get(endpoint)
if (data):
    #if response status 200
    data = requests.get(endpoint).json()    
    for item in data['items']:
        for cam in item['cameras']:
            camera_id = cam['camera_id']
            if camera_id == req_camera_id:	
                image = cam['image']
                wanted_cam.append(camera_id)
                wanted_url.append(image)
                time.append(cam['timestamp'])
                print(times[i])</code></pre>
  <p>The next lines of the code save the three lists (<code>camera_id</code>,
    <code>image</code> and <code>timestamp</code>) we will use as dataframe. Each list has <code>camera_id</code>,
    <code>image</code> and <code>timestamp</code> parameters of the json. We have added the column names (headers)
    so that we can manipulate the data easier..</p>
  <pre class="python"><code>df = pd.DataFrame(list(zip(wanted_cam, wanted_url,times)), 
                  columns =['Cam_id', 'Image','Timestamp_sg_time'])
df.set_index('Cam_id', inplace=True) 
df.to_csv('/your/path/Wed-1-20-20.csv', sep=',', encoding='utf-8')</code></pre>

<p align="justify">Now let's take a look at the main function. Here we have our <code>initial_time</code>, 
  <code>final_time</code> and <code>delta</code> variables. Since our API retrieve images every 20 secs, some timestamps won't be very 
  precise as it will return images that are closest to the specified point in time.</p>

  <p align="justify">The <code>while():</code> loop appends the timestamps according to the <code>delta</code>variable (set to 60 minutes, 
hence, equals to 24 photos) to our times list (Object list). Finally, we convert the date-time objects to strings <code>string_date_list</code> 
so we can call our function that receive a list as a parameter.</p>

<pre><code class="python">if __name__ == "__main__":
req_camera_id = '1701' #Filtrate by specific camera    
string_date_list = [] 

#Generate timestamps every delta minutes, initial_time, final_time and 
#delta parameters can be modified

initial_time = datetime.datetime(2020, 1, 20, 0, 0)
final_time = datetime.datetime(2020, 1, 21, 0, 0)
delta = datetime.timedelta(minutes=60) 
times = []    #list of timestamps
wanted_url=[] #list of image's URL
wanted_cam=[] #list of camera_ids

while initial_time < final_time:
    times.append(initial_time)
    initial_time += delta
  
  #Convert datetime objects to string list  
for i in range(len(times)):   

    #We place the "[T] to the timestamp format YYYY-MM-DD[T]HH:mm:ss "
    string_date_list.append((times[i].strftime('%Y/%m/%dT%H:%M:%S')))
getURLS(string_date_list)
</code></pre>
<div id ="1.4">
<h4><span class="header-section-number">1.4</span>
    Upload files to Dropbox</h4>
</div>
    <p align="justify">
      As the next chapter involves Google Colab, we must work in the cloud. To this end, we can 
create a function to upload our files to the cloud using a personal token. More precisely we'll use Dropbox.
    </p>
    <p>Login to your Dropbox account, if you don't have one register an account
and create an App in <a href="https://www.dropbox.com/developers/apps"> Developer apps.</a></p>
       <p>
         <img src="https://res.cloudinary.com/dxbnpu2rx/image/upload/v1612407804/app_ywawod.png" class="center">  
       </p>
    <p align="justify">Set the permissions to read and write on the App. The token need the particular scope required 
by the route in order to access the route. Otherwise, the Dropbox API will throw a <code>TokenScopeError</code>.</p>

<p>    <img src="https://res.cloudinary.com/dxbnpu2rx/image/upload/v1612415743/PERMITIONS_gtyjnj.png" class="center"></p>
      <p>On the left side we note OAuth 2 part. Here we click on "Generate" button to create an access token.
We copy and paste our token as a string in <code>dbx</code> variable. 
Note: the token last 4 hours if you don't modify Access token expiration.</p>

    <p>
    <img src="https://res.cloudinary.com/dxbnpu2rx/image/upload/v1612407999/OAuth_d5ic7f.png" class="center">  
  </p>
  <p>Then, we login to our <a href="https://www.dropbox.com/login">Dropbox</a> account.
  The application has been now created in our Apps directory</p>

  <p><img src="https://res.cloudinary.com/dxbnpu2rx/image/upload/v1612409387/dropbox_j9y3ja.png" class="center"></p>
<p align="justify">Here's the function that allows us to send our file to Dropbox. You can also do this manually,
  but once configurated the correct paths, the script will load it automatically.
</p>
      <pre><code>def uploadToDropbox(): 
    #Generate your access token with OAuth guide from dropbox developers documentation  
    dbx = dropbox.Dropbox('Put your token here')
    
    #Local path were you have stored the csv file 
    rootdir = '/your/path/' 
    print ("Attempting to upload...")
    
    # walk return first the current folder that it walk, then tuples 
    #of dirs and files not "subdir, dirs, files"
    for dir, dirs, files in os.walk(rootdir):
        for file in files:
            try:
                file_path = os.path.join(dir, file)
                dest_path = os.path.join('/', file) #root folder of dropbox app
                print('Uploading %s to %s' % (file_path, dest_path))
                with open(file_path, "br") as f:
                    dbx.files_upload(f.read(), dest_path, mute=True)
                print("Finished upload.")
            except Exception as err:
                print("Failed to upload %s\n%s" % (file, err))</code></pre>
                <p>We can simply call <code>uploadToDropbox()</code> 
                function in our main function below <code>getURLS(string_date_list)</code>line.</p>
      <p>You can download the complete script <a href="Filter_by_camera.py"> here</a> and run it in you
      preferred IDE.</p>
<p align="justify">Once we run the script, the file <a href="Wed1-20-20.csv"> Wed1-20-20.csv </a>will be downloaded in your path
and into your Dropbox App.</p>
<p><img src="https://res.cloudinary.com/dxbnpu2rx/image/upload/v1612416485/done_sjkgzo.png" class="center"></p>
<p>An output of the code look like this:</p>
<pre>2020-01-20 00:00:00 
2020-01-20 01:00:00
2020-01-20 02:00:00
2020-01-20 03:00:00
2020-01-20 04:00:00
2020-01-20 05:00:00
2020-01-20 06:00:00
2020-01-20 07:00:00
2020-01-20 09:00:00
2020-01-20 09:00:00
2020-01-20 10:00:00
2020-01-20 11:00:00
2020-01-20 12:00:00
2020-01-20 13:00:00
2020-01-20 14:00:00
2020-01-20 15:00:00
2020-01-20 16:00:00
2020-01-20 17:00:00
2020-01-20 18:00:00
2020-01-20 19:00:00
2020-01-20 20:00:00
2020-01-20 21:00:00
2020-01-20 22:00:00
2020-01-20 23:00:00
Attempting to upload...
Uploading /home/Wed1-20-20.csv to/Wed1-20-20.csv
Finished upload.</pre>

<p>Finally, the csv file should look like this:</p>
<p><img src="https://res.cloudinary.com/dxbnpu2rx/image/upload/v1614729151/csv_o3zhtc.png" class="center"></p>

</div>
            </section>
          </div>
        </div>
        <a href="index.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
        <a href="model.html" class="navigation navigation-next navigation-unique" aria-label="Next page" style="margin-right: 9px;"><i class="fa fa-angle-right"></i></a>
      </div>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
